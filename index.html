<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Daily Tracker</title>

    <!-- Google Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">

    <!-- PWA -->
    <link rel="manifest" href="manifest.json"> <!-- Keep for PWA -->

    <!-- Favicon -->
    <link rel="icon" type="image/png" href="https://i.postimg.cc/Ss3nBBsN/Stake-logo-svg.png">

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- REMOVED: Separate Chart.js Helpers script - usually included in core -->
    <!-- <script src="https://cdn.jsdelivr.net/npm/chart.js/dist/helpers.js"></script> -->


    <!-- Icons (Simple SVG for Sun/Moon + New Icons) -->
    <style>
      .icon { display: inline-block; width: 1em; height: 1em; vertical-align: -0.15em; fill: currentColor; margin-right: 5px; /* Added margin */ }
      .profit-loss-value.positive { color: var(--success-color); }
      .profit-loss-value.negative { color: var(--header-color); } /* Using header color for loss */
      .profit-loss-value.neutral { color: var(--text-muted); } /* Added neutral color */

      /* Style for edit/action buttons in history table */
      .history-action-btn {
            background: none; border: none; color: var(--accent-color); cursor: pointer;
            font-size: 0.9em; padding: 2px 5px; margin-left: 5px; vertical-align: middle;
            display: inline-flex; /* Align icon and text */
            align-items: center;
      }
      .history-action-btn .icon { margin-right: 3px; margin-left: 0; }
      .history-action-btn:hover:not(:disabled) { text-decoration: underline; }
      .history-action-btn:disabled { color: var(--text-muted); cursor: not-allowed; }

      /* Style for disabled utility buttons */
      .utility-btn:disabled {
          cursor: not-allowed;
          opacity: 0.5;
          border-color: var(--border-color); /* Keep border consistent */
          color: var(--text-muted); /* Keep color consistent */
      }
       .utility-btn:disabled:hover {
           transform: none; /* Prevent hover effect when disabled */
       }

        /* Enhanced Statistics Styles */
        #statsContainer {
            margin-top: 15px;
            margin-bottom: 20px;
            padding: 15px;
            background-color: var(--section-bg); /* Use new section background */
            border: 1px solid var(--border-color);
            border-radius: 8px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); /* Responsive grid */
            gap: 10px 15px; /* Row and column gap */
            font-size: 0.9em;
        }
        .stat-item {
            display: flex;
            flex-direction: column; /* Stack label and value */
        }
        .stat-item .label {
            font-size: 0.85em;
            color: var(--text-muted);
            margin-bottom: 2px;
        }
        .stat-item .value {
            font-weight: 600;
            color: var(--text-color);
        }
        .stat-item .value.positive { color: var(--success-color); }
        .stat-item .value.negative { color: var(--header-color); }
        .stat-item .value.neutral { color: var(--text-muted); }

        /* History Filter Styles */
        #historyFilterContainer {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            align-items: center;
            flex-wrap: wrap; /* Allow wrapping on small screens */
        }
        #historyFilterContainer label {
            font-size: 0.9em;
            color: var(--text-muted);
            margin-right: 5px;
        }
        #historyFilterInput {
            flex-grow: 1; /* Take remaining space */
            padding: 6px 10px;
            border-radius: 6px;
            border: 1px solid var(--input-border);
            background-color: var(--input-bg);
            color: var(--text-color);
            font-family: inherit;
            font-size: 0.9em;
            min-width: 150px; /* Minimum width */
        }
        #clearHistoryFilterBtn {
            padding: 6px 10px;
            font-size: 0.85em;
            background: var(--text-muted);
            color: var(--card-bg); /* Use card-bg for contrast */
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
         #clearHistoryFilterBtn:hover {
            background: var(--header-color);
            color: white;
         }

    </style>

    <!-- Theme Color for Browser UI -->
    <meta name="theme-color" content="#4a4e69"> <!-- Will be updated by JS -->

    <style>
        /* --- Reset and Base --- */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { width: 100%; min-height: 100%; overflow-x: hidden; /* Prevent horizontal scroll on body */ }
        body {
            font-family: 'Poppins', sans-serif;
            transition: background-color 0.3s ease, color 0.3s ease;
            background-color: #021027; /* Set base background color */
        }

        /* --- Animated Background Styles --- */
        #background-container { position: fixed; /* Keep background fixed */ top: 0; left: 0; width: 100%; height: 100%; overflow: hidden; z-index: -1; }
        .background-image { display: block; position: absolute; top: 0; left: 0; object-fit: cover; width: 100%; height: 100%; mask-image: radial-gradient(white 0%, white 30%, transparent 80%, transparent); pointer-events: none; opacity: 0.7; /* Slightly reduce opacity */ }
        .circle-container { position: absolute; transform: translateY(-10vh); animation-iteration-count: infinite; animation-timing-function: linear; pointer-events: none; }
        .circle { width: 100%; height: 100%; border-radius: 50%; mix-blend-mode: screen; background-image: radial-gradient(hsl(180, 100%, 80%), hsl(180, 100%, 80%) 10%, hsla(180, 100%, 80%, 0) 56%); animation: fade-frames 200ms infinite, scale-frames 2s infinite; }
        @keyframes fade-frames { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }
        @keyframes scale-frames { 0% { transform: scale3d(0.4, 0.4, 1); } 50% { transform: scale3d(2.2, 2.2, 1); } 100% { transform: scale3d(0.4, 0.4, 1); } }
        /* Dynamic keyframes will be added by JS */


        /* --- Theme Variables --- */
        :root {
            --font-family: 'Poppins', sans-serif;
            --shadow-opacity-dark: 0.15; --shadow-opacity-light: 0.08; /* Reduced shadow */
            /* Dark Theme */
            --card-bg-dark: rgba(42, 42, 62, 0.85); /* Still used for modals */
            --section-bg-dark: rgba(30, 30, 45, 0.6); /* NEW: Subtle background for sections */
            --text-color-dark: #e0e0e0; --text-muted-dark: #a0a0c0; --header-color-dark: #ff6b6b; --accent-color-dark: #ff8c42; --border-color-dark: rgba(64, 64, 90, 0.5); /* Softened border */ --button-bg-dark: linear-gradient(135deg, #ff6b6b, #ff8c42); --button-hover-bg-dark: linear-gradient(135deg, #ff8c42, #ff6b6b); --button-disabled-bg-dark: rgba(85, 85, 85, 0.8); --progress-bg-dark: rgba(64, 64, 90, 0.7); --progress-fill-dark: var(--accent-color-dark); --success-color-dark: #57cc99; --success-bg-dark: rgba(87, 204, 153, 0.2); --warning-color-dark: #ffcc00; --warning-bg-dark: rgba(255, 204, 0, 0.15); --input-bg-dark: rgba(60, 60, 80, 0.7); --input-border-dark: rgba(80, 80, 110, 0.8);
            /* Light Theme */
            --card-bg-light: rgba(255, 255, 255, 0.9); /* Still used for modals */
            --section-bg-light: rgba(245, 245, 250, 0.7); /* NEW: Subtle background for sections */
            --text-color-light: #333333; --text-muted-light: #777777; --header-color-light: #d90429; --accent-color-light: #ef476f; --border-color-light: rgba(200, 200, 220, 0.6); /* Softened border */ --button-bg-light: linear-gradient(135deg, #d90429, #ef476f); --button-hover-bg-light: linear-gradient(135deg, #ef476f, #d90429); --button-disabled-bg-light: rgba(204, 204, 204, 0.8); --progress-bg-light: rgba(224, 224, 224, 0.8); --progress-fill-light: var(--accent-color-light); --success-color-light: #2a9d8f; --success-bg-light: rgba(42, 157, 143, 0.2); --warning-color-light: #ff8c42; --warning-bg-light: rgba(255, 140, 66, 0.15); --input-bg-light: rgba(240, 240, 240, 0.8); --input-border-light: rgba(200, 200, 200, 0.9);
            /* Default to Dark */
            --card-bg: var(--card-bg-dark); --section-bg: var(--section-bg-dark); --text-color: var(--text-color-dark); --text-muted: var(--text-muted-dark); --header-color: var(--header-color-dark); --accent-color: var(--accent-color-dark); --border-color: var(--border-color-dark); --button-bg: var(--button-bg-dark); --button-hover-bg: var(--button-hover-bg-dark); --button-disabled-bg: var(--button-disabled-bg-dark); --progress-bg: var(--progress-bg-dark); --progress-fill: var(--progress-fill-dark); --success-color: var(--success-color-dark); --success-bg: var(--success-bg-dark); --warning-color: var(--warning-color-dark); --warning-bg: var(--warning-bg-dark); --input-bg: var(--input-bg-dark); --input-border: var(--input-border-dark); --shadow-opacity: var(--shadow-opacity-dark);
        }
        body.light-mode {
            background-color: #eef2f7; /* Lighter base background for light mode */
            --card-bg: var(--card-bg-light); --section-bg: var(--section-bg-light); --text-color: var(--text-color-light); --text-muted: var(--text-muted-light); --header-color: var(--header-color-light); --accent-color: var(--accent-color-light); --border-color: var(--border-color-light); --button-bg: var(--button-bg-light); --button-hover-bg: var(--button-hover-bg-light); --button-disabled-bg: var(--button-disabled-bg-light); --progress-bg: var(--progress-bg-light); --progress-fill: var(--progress-fill-light); --success-color: var(--success-color-light); --success-bg: var(--success-bg-light); --warning-color: var(--warning-color-light); --warning-bg: var(--warning-bg-light); --input-bg: var(--input-bg-light); --input-border: var(--input-border-light); --shadow-opacity: var(--shadow-opacity-light);
        }

        /* --- App Wrapper & Content Styles --- */
        #app-wrapper {
            position: relative; width: 100%; min-height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; padding: 40px 15px 60px 15px; /* Increased top/bottom padding */ z-index: 1;
        }
        h1 {
            font-weight: 700; font-size: 2.2em; margin-bottom: 10px; /* Adjusted margin */ background: linear-gradient(45deg, var(--header-color), var(--accent-color)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; text-align: center; position: relative; z-index: 2;
        }
        #quoteDisplay {
            color: var(--text-muted); font-style: italic; margin-bottom: 25px; /* Increased margin */ text-align: center; max-width: 550px; font-size: 0.95em; padding: 0 10px; min-height: 1.1em; /* Prevent layout shift */
             aria-live: "polite";
        }

        /* --- Tracker Container (Now mainly for structure/width control) --- */
        #tracker-container {
            /* REMOVED: background-color, padding, border, border-radius, box-shadow, backdrop-filter */
            max-width: 650px; /* Slightly wider max-width */
            width: 100%;
            text-align: center;
            margin-bottom: 30px; /* Spacing below container */
            position: relative; /* Keep for utility buttons */
            z-index: 2;
            display: flex; /* Use flex for easier vertical spacing */
            flex-direction: column;
            gap: 20px; /* Space between direct children (summary, progress, sections) */
        }

        /* --- Summary, Streak, Progress Bar --- */
        #summary-progress-group { /* New wrapper for top info */
             display: flex; flex-direction: column; align-items: center; gap: 5px; /* Space between summary, streak, progress */
             width: 100%;
        }
        #summary {
             font-size: 1.0em; /* Slightly larger */ color: var(--text-muted); min-height: 1.1em;
             aria-live: "polite";
        }
         #streak-info {
             font-size: 0.9em; color: var(--accent-color); min-height: 1em; font-weight: 600;
             aria-live: "polite";
         }
        #summary span { font-weight: 600; color: var(--text-color); }
        #progress-bar-container {
            width: 100%; height: 10px; /* Slightly thicker */ background-color: var(--progress-bg); border-radius: 5px; overflow: hidden; margin-top: 10px; /* Space above progress bar */ transition: background-color 0.3s ease;
        }
        #progress-bar-fill { width: 0%; height: 100%; background-color: var(--progress-fill); border-radius: 5px; transition: width 0.5s ease-out, background-color 0.3s ease; }

        /* --- Current Day & Completion Sections --- */
        #current-day-info, #completion-section, #all-complete-message, #loading-message, #error-message {
            background-color: var(--section-bg); /* Use new section background */
            padding: 20px 25px; /* Adjust padding */
            border-radius: 12px; /* Softer corners */
            border: 1px solid var(--border-color);
            width: 100%;
            text-align: left; /* Default align left */
            transition: background-color 0.3s ease, border-color 0.3s ease;
            backdrop-filter: blur(3px); /* Subtle blur for sections */
            -webkit-backdrop-filter: blur(3px);
            box-shadow: 0 4px 15px -5px rgba(0, 0, 0, var(--shadow-opacity)); /* Subtle shadow */
        }

        #current-day-info h2 {
            color: var(--header-color); margin-top: 0; margin-bottom: 20px; font-size: 2.0em; font-weight: 700; text-align: center; /* Center Day number */
        }
        #current-day-info h2 span { font-weight: 300; margin-right: 5px; }
        .info-item {
            display: flex; align-items: center; padding: 12px 0; border-bottom: 1px solid var(--border-color); font-size: 1.0em; transition: border-color 0.3s ease;
        }
        #current-day-info .info-item:last-of-type { border-bottom: none; } /* Keep this */
        .info-item .label-group { display: flex; align-items: center; color: var(--text-muted); }
        .info-item .label-group .icon { margin-right: 8px; font-size: 1.2em; opacity: 0.8; }
        .info-item .value { font-weight: 600; color: var(--text-color); margin-left: auto; }
        #actualProfitLossItem { /* Style for the profit/loss item */
            padding-top: 10px; /* Add some space above */
            border-top: 1px dashed var(--border-color); /* Separator */
            margin-top: 10px;
        }

        #completion-section { margin-top: 0; /* Remove top margin, rely on parent gap */ padding-top: 20px; }
        .input-group { margin-bottom: 15px; text-align: left; }
        .input-group label { display: block; margin-bottom: 5px; font-weight: 600; color: var(--text-muted); font-size: 0.9em; }
        .input-group input, .input-group textarea, .input-group .read-only-value {
            width: 100%; padding: 10px 12px; border-radius: 8px; border: 1px solid var(--input-border); background-color: var(--input-bg); color: var(--text-color); font-family: inherit; font-size: 1em; transition: background-color 0.3s, border-color 0.3s;
        }
        .input-group textarea {
            min-height: 60px; resize: vertical; font-size: 0.95em; line-height: 1.4;
        }
        .input-group .read-only-value {
             background-color: rgba(0,0,0,0.1); cursor: default; color: var(--text-muted);
        }

        .button-group {
            display: flex; justify-content: center; gap: 15px; margin-top: 25px;
        }
        .button-group button, .action-button { /* Keep button styles */
            width: 100%; max-width: 300px; /* Slightly wider max */ padding: 12px 15px; border: none; color: white; border-radius: 10px; cursor: pointer; transition: background 0.3s ease, transform 0.1s ease, box-shadow 0.2s ease; font-size: 1.0em; font-weight: 600; letter-spacing: 0.5px; box-shadow: 0 4px 15px -3px rgba(0,0,0,0.1);
        }
        #completeBtn { background: var(--button-bg); }
        #completeBtn:hover:not(:disabled) { background: var(--button-hover-bg); transform: translateY(-2px); box-shadow: 0 6px 20px -3px rgba(0,0,0,0.15); }
        #completeBtn:active:not(:disabled) { transform: translateY(0px); box-shadow: 0 2px 10px -3px rgba(0,0,0,0.1); }
        #completeBtn:disabled { background: var(--button-disabled-bg); cursor: not-allowed; opacity: 0.7; box-shadow: none; }

        #all-complete-message {
            font-size: 1.4em; color: var(--success-color); font-weight: 600; padding: 25px; background-color: var(--success-bg); border: 1px solid var(--success-color); border-radius: 12px; margin-top: 0; /* Rely on parent gap */ text-align: center;
        }
        #loading-message { text-align: center; color: var(--text-muted); }
        #error-message { background-color: var(--warning-bg); color: var(--warning-color); border: 1px solid var(--warning-color); text-align: center; }

        #milestone-toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background-color: var(--success-bg); color: var(--success-color); padding: 15px 25px; border-radius: 10px; border: 1px solid var(--success-color); z-index: 100; font-weight: 600; box-shadow: 0 5px 15px rgba(0,0,0,0.2); opacity: 0; visibility: hidden; transition: opacity 0.5s ease, visibility 0.5s ease, bottom 0.5s ease; backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); }
        #milestone-toast.show { opacity: 1; visibility: visible; bottom: 30px; }

        /* --- Utility Buttons --- */
        #utility-buttons {
            position: absolute; top: 10px; right: 10px; display: flex; gap: 8px; z-index: 3;
        }
        .utility-btn {
            background: rgba(0,0,0,0.1); /* Subtle background */ border: 1px solid var(--border-color); color: var(--text-muted); border-radius: 50%; width: 34px; /* Slightly larger */ height: 34px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.3s ease; font-size: 1.1em; backdrop-filter: blur(2px); -webkit-backdrop-filter: blur(2px);
        }
        .utility-btn:hover:not(:disabled) { color: var(--text-color); border-color: var(--text-muted); transform: rotate(15deg); background: rgba(0,0,0,0.2); }
        body.light-mode .utility-btn { background: rgba(255,255,255,0.2); }
        body.light-mode .utility-btn:hover:not(:disabled) { background: rgba(255,255,255,0.4); }
        .sun-icon { display: none; } .moon-icon { display: block; } body.light-mode .sun-icon { display: block; } body.light-mode .moon-icon { display: none; }

        /* --- Modal Styles --- */
        .modal { display: none; position: fixed; z-index: 50; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.7); /* Darker overlay */ backdrop-filter: blur(5px); /* Increased blur */ -webkit-backdrop-filter: blur(5px); align-items: center; justify-content: center; padding: 20px; }
        .modal.show { display: flex; animation: fadeIn 0.3s ease; }
        .modal-content {
            background-color: var(--card-bg); /* Keep card style for modals */ margin: auto; padding: 25px 25px; /* Slightly more padding */ border: 1px solid var(--border-color); border-radius: 15px; width: 95%; max-width: 700px; /* Increased max-width */ position: relative; box-shadow: 0 10px 30px rgba(0,0,0, var(--shadow-opacity)); max-height: 85vh; overflow-y: auto;
        }
        .modal-close { color: var(--text-muted); position: absolute; top: 10px; right: 15px; font-size: 30px; font-weight: bold; cursor: pointer; transition: color 0.2s ease; }
        .modal-close:hover, .modal-close:focus { color: var(--text-color); text-decoration: none; }
        .modal h2 { color: var(--header-color); margin-top: 0; margin-bottom: 25px; text-align: center; font-size: 1.7em; }
        .modal .input-group label { font-size: 0.95em; display: flex; align-items: center; }
        .modal .action-button { margin-top: 20px; width: 100%; background: var(--button-bg); }
        .modal .action-button:hover:not(:disabled) { background: var(--button-hover-bg); }
        #resetBtn { background: var(--header-color); margin-top: 10px; }
        #resetBtn:hover:not(:disabled) { background: #c00; }
        #exportBtn { background: var(--accent-color); margin-top: 15px; width: auto; padding: 10px 20px; font-size: 0.9em; }
        /* Settings Modal Specifics */
        .checkbox-group { display: flex; align-items: center; margin-bottom: 15px; }
        .checkbox-group input[type="checkbox"] { margin-right: 10px; width: auto; accent-color: var(--accent-color); }
        .checkbox-group label { margin-bottom: 0; font-weight: normal; color: var(--text-color); }

        /* --- History Table Responsive Wrapper --- */
        .table-responsive-wrapper {
            width: 100%; overflow-x: auto; -webkit-overflow-scrolling: touch; margin-top: 15px; border: 1px solid var(--border-color); border-radius: 8px; background-color: var(--input-bg); /* Give table wrapper a subtle bg */
        }
        #historyTable {
            width: 100%; min-width: 700px; border-collapse: collapse;
        }
        #historyTable th, #historyTable td {
            border: 1px solid var(--border-color); padding: 10px 12px; /* Slightly more padding */ text-align: left; font-size: 0.9em; white-space: nowrap; vertical-align: middle;
        }
        #historyTable th { background-color: var(--section-bg); /* Use section bg for header */ color: var(--text-color); font-weight: 600; position: sticky; top: 0; z-index: 1; }
        #historyTable td .status-complete { color: var(--success-color); font-weight: 600; }
        #historyTable .actual-end-cell {
            display: flex; justify-content: space-between; align-items: center; gap: 5px;
        }
        #historyTable .notes-cell {
            white-space: normal; min-width: 150px; max-width: 250px;
        }
        #historyTable .notes-content {
            display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; text-overflow: ellipsis; cursor: pointer; margin-right: 5px;
        }
        #historyTable .actions-cell { white-space: nowrap; }

        #chartContainer {
            margin-bottom: 15px; height: 250px; /* Slightly taller chart */
            padding: 10px; /* Add padding around canvas */
            background-color: var(--section-bg); /* Match section bg */
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }


        /* --- MEDIA QUERIES FOR RESPONSIVENESS --- */
        @media (max-width: 768px) {
            h1 { font-size: 2.0em; }
            #tracker-container { max-width: 95%; gap: 15px; } /* Reduce gap */
            #current-day-info, #completion-section, #all-complete-message, #loading-message, #error-message { padding: 15px 20px; }
            .modal-content { padding: 20px 20px; max-width: 90%; }
            #historyTable { min-width: 650px; }
            #statsContainer { grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); font-size: 0.85em;}
            #chartContainer { height: 220px; }
        }

        @media (max-width: 480px) {
            #app-wrapper { padding: 30px 10px 40px 10px; }
            h1 { font-size: 1.8em; }
            #tracker-container { gap: 12px; margin-bottom: 20px; }
            #quoteDisplay { margin-bottom: 20px; font-size: 0.9em; }
             #utility-buttons { gap: 5px; top: 5px; right: 5px; }
             .utility-btn { width: 32px; height: 32px; font-size: 1.0em; }

            #current-day-info, #completion-section, #all-complete-message, #loading-message, #error-message { padding: 15px 15px; border-radius: 10px; }
            #current-day-info h2 { font-size: 1.8em; margin-bottom: 15px; }
            .info-item { flex-direction: column; align-items: flex-start; padding: 10px 0; }
            .info-item .label-group { margin-bottom: 4px; font-size: 0.9em; }
             .info-item .value { font-size: 1.0em; margin-left: 0; margin-top: 2px; }
             #actualProfitLossItem { align-items: flex-start; }

            .button-group button { max-width: none; font-size: 0.95em; padding: 11px 15px; }
            #completion-section { padding-top: 15px;}
            .input-group label { font-size: 0.85em;}
            .input-group input, .input-group textarea { padding: 9px 10px; font-size: 0.95em; }
            .input-group textarea { font-size: 0.9em; }

            .modal-content { width: 96%; padding: 15px 12px; max-width: 96%; }
            .modal h2 { font-size: 1.4em; margin-bottom: 20px; }
            #historyTable { min-width: 600px; }
            #historyTable th, #historyTable td { padding: 8px 10px; font-size: 0.85em;}
            .history-action-btn { font-size: 0.8em; margin-left: 3px;}
            #historyTable .notes-cell { min-width: 120px; max-width: 200px; }
             #chartContainer { height: 200px; padding: 5px; }
             #exportBtn { font-size: 0.85em; padding: 8px 15px;}

             #all-complete-message { font-size: 1.2em; padding: 20px; }
             #milestone-toast { font-size: 0.9em; padding: 12px 20px; bottom: 15px; width: 90%; }
             .modal .input-group label .icon { font-size: 1.1em; }

             #statsContainer { grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 8px; padding: 10px; font-size: 0.8em; }
             #historyFilterContainer { flex-direction: column; align-items: stretch; }
             #historyFilterInput { min-width: 0; }
        }

    </style>
</head>
<body>
    <!-- Background Elements -->
    <div id="background-container">
        <img src="https://s3-us-west-2.amazonaws.com/s.cdpn.io/221808/sky.jpg" class="background-image" alt="">
        <!-- Particles will be added by JS -->
    </div>

    <!-- App Content Wrapper -->
    <div id="app-wrapper">
        <!-- Inlined SVG Icons (Keep as is) -->
        <svg width="0" height="0" style="position:absolute">
          <symbol id="icon-sun" viewBox="0 0 24 24"><path fill="currentColor" d="M12 7c-2.76 0-5 2.24-5 5s2.24 5 5 5 5-2.24 5-5-2.24-5-5-5zM2 13h2c.55 0 1-.45 1-1s-.45-1-1-1H2c-.55 0-1 .45-1 1s.45 1 1 1zm18 0h2c.55 0 1-.45 1-1s-.45-1-1-1h-2c-.55 0-1 .45-1 1s.45 1 1 1zM11 2v2c0 .55.45 1 1 1s1-.45 1-1V2c0-.55-.45-1-1-1s-1 .45-1 1zm0 18v2c0 .55.45 1 1 1s1-.45 1-1v-2c0-.55-.45-1-1-1s-1 .45-1 1zM5.64 5.64c-.39-.39-1.02-.39-1.41 0-.39.39-.39 1.02 0 1.41l1.06 1.06c.39.39 1.02.39 1.41 0s.39-1.02 0-1.41L5.64 5.64zm12.73 12.73c-.39-.39-1.02-.39-1.41 0-.39.39-.39 1.02 0 1.41l1.06 1.06c.39.39 1.02.39 1.41 0 .39-.39.39-1.02 0-1.41l-1.06-1.06zM18.36 5.64c.39-.39.39-1.02 0-1.41-.39-.39-1.02-.39-1.41 0l-1.06 1.06c-.39.39-.39 1.02 0 1.41s1.02.39 1.41 0l1.06-1.06zm-12.73 12.73c.39-.39.39-1.02 0-1.41-.39-.39-1.02-.39-1.41 0l-1.06 1.06c-.39.39-.39 1.02 0 1.41s1.02.39 1.41 0l1.06-1.06z"/></symbol>
          <symbol id="icon-moon" viewBox="0 0 24 24"><path fill="currentColor" d="M9.37 5.51A7.35 7.35 0 0 0 9.1 7.5c0 4.08 3.32 7.4 7.4 7.4c.36 0 .71-.03 1.05-.08c-.43.91-.98 1.75-1.63 2.46c-1.94 2.09-4.75 3.4-7.77 3.4C5.22 23.78 2 20.71 2 16.75c0-3.46 2.01-6.5 4.93-7.82c.64-.29 1.3-.5 1.98-.65c.04-.01.09-.02.13-.03c.01 0 .02-.01.03-.01z"/></symbol>
          <symbol id="icon-start" viewBox="0 0 24 24"><path fill="currentColor" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10s10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8s8 3.59 8 8s-3.59 8-8 8zm-1-13h2v6h-2zm0 8h2v2h-2z"/></symbol>
          <symbol id="icon-profit" viewBox="0 0 24 24"><path fill="currentColor" d="M3.5 18.49l6-6.01l4 4L22 6.92l-1.41-1.41l-7.09 7.09l-4-4l-7.5 7.51L3.5 18.49z"/></symbol>
           <symbol id="icon-loss" viewBox="0 0 24 24"><path fill="currentColor" d="M22 17.92l-1.41 1.41l-7.09-7.09l-4 4l-7.5-7.51L3.5 6.01l6 6.01l4-4L22 17.92z"/></symbol> <!-- Added Loss Icon -->
          <symbol id="icon-target" viewBox="0 0 24 24"><path fill="currentColor" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10s10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8s8 3.59 8 8s-3.59 8-8 8zm-5-8c0-1.66 1.34-3 3-3s3 1.34 3 3s-1.34 3-3 3s-3-1.34-3-3z"/></symbol>
           <symbol id="icon-settings" viewBox="0 0 24 24"><path fill="currentColor" d="M19.43 12.98c.04-.32.07-.64.07-.98s-.03-.66-.07-.98l2.11-1.65c.19-.15.24-.42.12-.64l-2-3.46c-.12-.22-.39-.3-.61-.22l-2.49 1c-.52-.4-1.08-.73-1.69-.98l-.38-2.65C14.46 2.18 14.25 2 14 2h-4c-.25 0-.46.18-.49.42l-.38 2.65c-.61.25-1.17.59-1.69.98l-2.49-1c-.23-.09-.49 0-.61.22l-2 3.46c-.13.22-.07.49.12.64l2.11 1.65c-.04.32-.07.65-.07.98s.03.66.07.98l-2.11 1.65c-.19.15-.24.42-.12.64l2 3.46c.12.22.39.3.61.22l2.49-1c.52.4 1.08.73 1.69.98l.38 2.65c.03.24.24.42.49.42h4c.25 0 .46-.18.49-.42l.38-2.65c.61-.25 1.17-.59 1.69.98l2.49 1c.23.09.49 0 .61.22l2-3.46c.12-.22.07-.49-.12-.64l-2.11-1.65zM12 15.5c-1.93 0-3.5-1.57-3.5-3.5s1.57-3.5 3.5-3.5 3.5 1.57 3.5 3.5-1.57 3.5-3.5 3.5z"/></symbol>
           <symbol id="icon-history" viewBox="0 0 24 24"><path fill="currentColor" d="M13 3a9 9 0 0 0-9 9H1l3.89 3.89l.07.14L9 12H6c0-3.87 3.13-7 7-7s7 3.13 7 7s-3.13 7-7 7c-1.93 0-3.68-.79-4.94-2.06l-1.42 1.42A8.954 8.954 0 0 0 13 21a9 9 0 0 0 9-9a9 9 0 0 0-9-9zm-1 5v5l4.25 2.52l.77-1.28l-3.52-2.09V8z"/></symbol>
           <symbol id="icon-actual" viewBox="0 0 24 24"><path fill="currentColor" d="M21 6H3c-1.1 0-2 .9-2 2v8c0 1.1.9 2 2 2h18c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2zm0 10H3V8h2v4h2V8h2v4h2V8h2v4h2V8h2v4h2V8h2v8z"/></symbol>
           <symbol id="icon-balance" viewBox="0 0 24 24"><path fill="currentColor" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10s10-4.48 10-10S17.52 2 12 2zm-3.5 13.25L6 12.75l1.41-1.41L10.5 14.44l6.09-6.09L18 9.75l-7.5 7.5z" /></symbol> <!-- Simple Balance icon -->
           <symbol id="icon-rate" viewBox="0 0 24 24"><path fill="currentColor" d="M16 6l2.29 2.29-4.88 4.88-4-4L2 16.59 3.41 18l6-6 4 4 6.3-6.29L22 12V6h-6z"/></symbol> <!-- Trend Up Icon -->
           <symbol id="icon-days" viewBox="0 0 24 24"><path fill="currentColor" d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11zM7 10h5v5H7v-5z"/></symbol> <!-- Calendar Icon -->
           <symbol id="icon-currency" viewBox="0 0 24 24"><path fill="currentColor" d="M7 15h2c1.1 0 2-.9 2-2v-2c0-1.1-.9-2-2-2H6v2h3v2H7c-1.1 0-2 .9-2 2v2c0 1.1.9 2 2 2h3v2H6v-2zM17 7H11v10h1v-4h4v-2h-4V9h6V7z"/></symbol> <!-- Currency Icon -->
           <symbol id="icon-edit" viewBox="0 0 24 24"><path fill="currentColor" d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></symbol> <!-- Edit Icon -->
           <symbol id="icon-notes" viewBox="0 0 24 24"><path fill="currentColor" d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83zM15 5H5v14h14v-9.09l-2-2V17H7v-7h5.59L15 7.41V5z"/></symbol> <!-- Notes/Journal Icon (Modified Edit) -->
           <symbol id="icon-stats" viewBox="0 0 24 24"><path fill="currentColor" d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-5h7v5zm3-7H7V7h10v3zm-3 7h3v-5h-3v5z"/></symbol> <!-- Stats Icon -->
           <symbol id="icon-weekend" viewBox="0 0 24 24"><path fill="currentColor" d="M20 3h-1V1h-2v2H7V1H5v2H4c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 18H4V8h16v13zM7.5 13h2v2h-2zM11 13h2v2h-2zM14.5 13h2v2h-2z"/></symbol> <!-- Weekend Icon -->
           <symbol id="icon-search" viewBox="0 0 24 24"><path fill="currentColor" d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5A6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></symbol> <!-- Search Icon -->
           <symbol id="icon-clear" viewBox="0 0 24 24"><path fill="currentColor" d="M19 6.41L17.59 5L12 10.59L6.41 5L5 6.41L10.59 12L5 17.59L6.41 19L12 13.41L17.59 19L19 17.59L13.41 12L19 6.41z"/></symbol> <!-- Clear/Close Icon -->
        </svg>

        <h1>Daily Tracker</h1>
        <div id="quoteDisplay" aria-live="polite">Loading quote...</div>

        <!-- Tracker Container (Now mainly for structure/width) -->
        <div id="tracker-container">
            <div id="utility-buttons">
                <button id="themeToggleBtn" class="utility-btn" onclick="toggleTheme()" title="Toggle Theme">
                    <svg class="icon sun-icon"><use xlink:href="#icon-sun"></use></svg>
                    <svg class="icon moon-icon"><use xlink:href="#icon-moon"></use></svg>
                </button>
                 <button id="settingsBtn" class="utility-btn" onclick="openSettingsModal()" title="Settings" disabled>
                    <svg class="icon"><use xlink:href="#icon-settings"></use></svg>
                 </button>
                 <button id="historyBtn" class="utility-btn" onclick="openHistoryModal()" title="View History" disabled>
                    <svg class="icon"><use xlink:href="#icon-history"></use></svg>
                </button>
            </div>

            <!-- Group for Summary, Streak, Progress -->
            <div id="summary-progress-group">
                <div id="summary" aria-live="polite"></div>
                <div id="streak-info" aria-live="polite"></div>
                <div id="progress-bar-container">
                    <div id="progress-bar-fill"></div>
                </div>
            </div>

            <!-- Current Day Info Section -->
            <div id="current-day-info" style="display: none;">
                <h2><span>Day</span><span id="currentDayNumber">--</span></h2>
                <div class="info-item">
                    <span class="label-group"><svg class="icon"><use xlink:href="#icon-start"></use></svg> Start Balance:</span>
                    <span class="value"><span class="currency-symbol">â‚¹</span><span id="startBalance">--.--</span></span>
                </div>
                <div class="info-item">
                    <span class="label-group"><svg class="icon"><use xlink:href="#icon-profit"></use></svg> Target Profit:</span>
                    <span class="value"><span class="currency-symbol">â‚¹</span><span id="targetProfit">--.--</span></span>
                </div>
                <div class="info-item">
                    <span class="label-group"><svg class="icon"><use xlink:href="#icon-target"></use></svg> End Balance Target:</span>
                    <span class="value"><span class="currency-symbol">â‚¹</span><span id="endBalanceTarget">--.--</span></span>
                </div>
                 <!-- Actual Profit/Loss Item -->
                <div class="info-item" id="actualProfitLossItem" style="display: none;">
                    <span class="label-group"><svg class="icon"><use xlink:href="#icon-profit"></use></svg> Actual Profit / Loss:</span>
                    <span class="value profit-loss-value"><span class="currency-symbol">â‚¹</span><span id="actualProfitLoss">--.--</span></span>
                </div>
            </div>

            <!-- Completion Section -->
            <div id="completion-section" style="display: none;"> <!-- Hide initially until day info loads -->
                 <div class="input-group">
                    <label for="actualEndBalanceInput">
                        <svg class="icon" style="vertical-align: -0.1em;"><use xlink:href="#icon-actual"></use></svg> Actual End Balance (Optional):
                    </label>
                    <input type="number" id="actualEndBalanceInput" step="0.01" placeholder="Enter final balance for the day">
                </div>
                <div class="input-group">
                    <label for="dailyNotesInput">
                        <svg class="icon" style="vertical-align: -0.1em;"><use xlink:href="#icon-notes"></use></svg> Daily Notes (Optional):
                    </label>
                    <textarea id="dailyNotesInput" rows="3" placeholder="Add notes about the day's strategy, trades, or reflections..."></textarea>
                </div>
                <div class="button-group">
                    <button id="completeBtn" onclick="markCurrentDayComplete()" disabled>Mark Day -- Complete</button>
                </div>
            </div>

            <!-- Messages Area -->
            <div id="all-complete-message" style="display: none;">
                ðŸŽ‰ Congratulations! All days completed! ðŸŽ‰
            </div>
             <div id="loading-message" style="display: none;">
                Connecting to server... Please wait.
            </div>
             <div id="error-message" style="display: none;" aria-live="assertive">
                Error communicating with server. Please ensure it's running and refresh the page.
            </div>
        </div> <!-- End #tracker-container -->

        <!-- Milestone Toast Notification -->
        <div id="milestone-toast">Milestone Achieved!</div>

    </div> <!-- End #app-wrapper -->

    <!-- Settings Modal (Keep as is) -->
    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal('settingsModal')">Ã—</span>
            <h2>Tracker Settings</h2>
             <div class="input-group">
                <label for="initialBalanceSetting">
                    <svg class="icon"><use xlink:href="#icon-balance"></use></svg>Initial Balance:
                </label>
                <input type="number" id="initialBalanceSetting" step="0.01" min="0">
            </div>
             <div class="input-group">
                <label for="growthRateSetting">
                    <svg class="icon"><use xlink:href="#icon-rate"></use></svg>Daily Growth Rate (%):
                </label>
                <input type="number" id="growthRateSetting" step="0.01" min="0" placeholder="e.g., 18 for 18%">
            </div>
             <div class="input-group">
                <label for="totalDaysSetting">
                    <svg class="icon"><use xlink:href="#icon-days"></use></svg>Total Trading Days:
                </label>
                <input type="number" id="totalDaysSetting" step="1" min="1">
            </div>
             <div class="input-group">
                <label for="currencySymbolSetting">
                     <svg class="icon"><use xlink:href="#icon-currency"></use></svg>Currency Symbol:
                </label>
                <input type="text" id="currencySymbolSetting" maxlength="5">
            </div>
             <div class="checkbox-group">
                <input type="checkbox" id="skipWeekendsSetting">
                <label for="skipWeekendsSetting">
                     <svg class="icon" style="vertical-align: -0.1em;"><use xlink:href="#icon-weekend"></use></svg>Skip Weekends (Affects Day Progression)
                </label>
            </div>
            <div class="input-group">
                <label for="projectedEndBalanceDisplay">
                     <svg class="icon"><use xlink:href="#icon-target"></use></svg>Projected End Balance (approx.):
                </label>
                <div id="projectedEndBalanceDisplay" class="read-only-value">--.--</div>
            </div>

            <button class="action-button" onclick="saveSettings()">Save Settings</button>
            <button id="resetBtn" class="action-button" onclick="resetProgress()">Reset All Progress</button>
        </div>
    </div>

    <!-- History Modal (Keep as is) -->
     <div id="historyModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal('historyModal')">Ã—</span>
            <h2>Progress History</h2>
            <div id="statsContainer" aria-live="polite">
                 <div class="stat-item"><span class="label">Loading Stats...</span><span class="value">--</span></div>
            </div>

            <div id="chartContainer">
                 <canvas id="progressChartCanvas"></canvas>
            </div>
            <button id="exportBtn" class="action-button" onclick="exportData()" style="margin-bottom: 15px;">Export Data (CSV)</button>

            <div id="historyFilterContainer">
                <label for="historyFilterInput"><svg class="icon" style="margin-right: 3px; vertical-align: -0.1em;"><use xlink:href="#icon-search"></use></svg>Filter Notes:</label>
                <input type="text" id="historyFilterInput" placeholder="Search notes content...">
                <button id="clearHistoryFilterBtn" onclick="clearHistoryFilter()" title="Clear Filter">
                    <svg class="icon" style="margin: 0; vertical-align: -0.1em;"><use xlink:href="#icon-clear"></use></svg> Clear
                </button>
            </div>

            <div class="table-responsive-wrapper">
                 <table id="historyTable">
                    <thead>
                        <tr>
                            <th>Day</th>
                            <th>Status</th>
                            <th>Target Start</th>
                            <th>Target Profit</th>
                            <th>Target End</th>
                            <th>Actual End</th>
                            <th>Notes</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="historyTableBody">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

        <script>
        // --- Configuration ---
        const API_BASE_URL = '/api'; // Assuming your backend API is served from here

        // --- Global State ---
        let currentSettings = {};
        let currentDayData = {};
        let historyData = []; // Raw history from API
        let filteredHistoryData = []; // History data currently displayed (after filtering)
        let currentChart = null;

        // --- DOM Elements ---
        const summaryEl = document.getElementById('summary');
        const streakInfoEl = document.getElementById('streak-info');
        const progressBarFillEl = document.getElementById('progress-bar-fill');
        const currentDayInfoEl = document.getElementById('current-day-info');
        const completionSectionEl = document.getElementById('completion-section');
        const currentDayNumberEl = document.getElementById('currentDayNumber');
        const startBalanceEl = document.getElementById('startBalance');
        const targetProfitEl = document.getElementById('targetProfit');
        const endBalanceTargetEl = document.getElementById('endBalanceTarget');
        const actualEndBalanceInputEl = document.getElementById('actualEndBalanceInput');
        const dailyNotesInputEl = document.getElementById('dailyNotesInput'); // Get notes input
        const completeBtnEl = document.getElementById('completeBtn');
        const allCompleteMessageEl = document.getElementById('all-complete-message');
        const loadingMessageEl = document.getElementById('loading-message');
        const errorMessageEl = document.getElementById('error-message');
        const backgroundContainer = document.getElementById('background-container');
        const quoteDisplayEl = document.getElementById('quoteDisplay');
        const milestoneToastEl = document.getElementById('milestone-toast');
        const actualProfitLossItemEl = document.getElementById('actualProfitLossItem');
        const actualProfitLossEl = document.getElementById('actualProfitLoss');
        const profitLossIconEl = actualProfitLossItemEl.querySelector('.icon use');
        const profitLossValueEl = actualProfitLossItemEl.querySelector('.value');
        const settingsBtnEl = document.getElementById('settingsBtn');
        const historyBtnEl = document.getElementById('historyBtn');

        // Modals & Settings
        const settingsModalEl = document.getElementById('settingsModal');
        const historyModalEl = document.getElementById('historyModal');
        const initialBalanceSettingEl = document.getElementById('initialBalanceSetting');
        const growthRateSettingEl = document.getElementById('growthRateSetting');
        const totalDaysSettingEl = document.getElementById('totalDaysSetting');
        const currencySymbolSettingEl = document.getElementById('currencySymbolSetting');
        const skipWeekendsSettingEl = document.getElementById('skipWeekendsSetting');
        const projectedEndBalanceDisplayEl = document.getElementById('projectedEndBalanceDisplay');
        const historyTableBodyEl = document.getElementById('historyTableBody');
        const progressChartCanvasEl = document.getElementById('progressChartCanvas');
        const statsContainerEl = document.getElementById('statsContainer');
        const historyFilterInputEl = document.getElementById('historyFilterInput');
        const clearHistoryFilterBtnEl = document.getElementById('clearHistoryFilterBtn');

        // --- Utility Functions ---
        function showLoading() {
            loadingMessageEl.style.display = 'block';
            errorMessageEl.style.display = 'none';
            currentDayInfoEl.style.display = 'none';
            completionSectionEl.style.display = 'none';
            allCompleteMessageEl.style.display = 'none';
            summaryEl.innerHTML = 'Loading...';
            streakInfoEl.innerHTML = '';
            if (settingsBtnEl) settingsBtnEl.disabled = true;
            if (historyBtnEl) historyBtnEl.disabled = true;
            if (completeBtnEl) completeBtnEl.disabled = true;
        }

        function showError(message = "Error communicating with server. Please ensure it's running and refresh the page.") {
            loadingMessageEl.style.display = 'none';
            errorMessageEl.textContent = message;
            errorMessageEl.style.display = 'block';
            currentDayInfoEl.style.display = 'none';
            completionSectionEl.style.display = 'none';
            allCompleteMessageEl.style.display = 'none';
            summaryEl.innerHTML = 'Error loading data.';
            streakInfoEl.innerHTML = '';
            if (settingsBtnEl) settingsBtnEl.disabled = true; // Keep disabled on error
            if (historyBtnEl) historyBtnEl.disabled = true; // Keep disabled on error
            if (completeBtnEl) completeBtnEl.disabled = true;
        }

        function hideMessages() {
            loadingMessageEl.style.display = 'none';
            errorMessageEl.style.display = 'none';
        }

        function formatCurrency(value, symbol, options = {}) {
             const num = parseFloat(value);
             if (isNaN(num)) return `${symbol}--.--`;
             const defaultOptions = {
                 minimumFractionDigits: 2,
                 maximumFractionDigits: 2,
             };
             const mergedOptions = { ...defaultOptions, ...options };
             return `${symbol}${num.toLocaleString(undefined, mergedOptions)}`;
         }

        // --- Particle Generation ---
        const numParticles = 50;
        function createParticles() {
            const existingParticles = backgroundContainer.querySelectorAll('.circle-container');
            existingParticles.forEach(p => p.remove());
            let styleSheet = document.getElementById('dynamic-keyframes-style');
            if (!styleSheet) {
                styleSheet = document.createElement('style');
                styleSheet.id = 'dynamic-keyframes-style';
                document.head.appendChild(styleSheet);
            }

            for (let i = 0; i < numParticles; i++) {
                const circleContainer = document.createElement('div'); circleContainer.className = 'circle-container';
                const circle = document.createElement('div'); circle.className = 'circle';
                const size = Math.random() * 10 + 2;
                const duration = Math.random() * 20000 + 15000;
                const delay = Math.random() * 20000;
                const startX = Math.random() * 100;
                const endX = Math.random() * 100;
                const scaleDelay = Math.random() * 1000;
                circleContainer.style.width = `${size}px`; circleContainer.style.height = `${size}px`;
                const animationName = `move-frames-${Date.now()}-${i}`;
                circleContainer.style.animationName = animationName;
                circleContainer.style.animationDuration = `${duration}ms`;
                circleContainer.style.animationDelay = `${delay}ms`;
                circle.style.animationDelay = `${scaleDelay}ms`;
                circle.style.animationDuration = `${Math.random() * 1000 + 1500}ms`;
                const keyframes = `@keyframes ${animationName} { from { transform: translate3d(${startX}vw, 105vh, 0); } to { transform: translate3d(${endX}vw, -120vh, 0); } }`;
                try { styleSheet.sheet.insertRule(keyframes, styleSheet.sheet.cssRules.length); } catch (e) { console.warn(`Could not insert keyframe rule: ${animationName}`, e); }
                circleContainer.appendChild(circle); backgroundContainer.appendChild(circleContainer);
            }
         }

        // --- Quotes ---
        const motivationalQuotes = [ "The secret of getting ahead is getting started.", "Discipline is the bridge between goals and accomplishment.", "Consistency is key. Don't let a stumble become a fall.", "Focus on progress, not perfection.", "Small steps every day lead to massive results.", "Believe you can and you're halfway there.", "The only limit to our realization of tomorrow will be our doubts of today.", "Don't watch the clock; do what it does. Keep going.", "It's not whether you get knocked down, it's whether you get up.", "Success is the sum of small efforts, repeated day in and day out.", "Reflect on your actions, learn from your mistakes.", "Plan your trade, trade your plan." ];
        function displayQuote() { if (motivationalQuotes.length === 0) { quoteDisplayEl.textContent = ""; return; } const randomIndex = Math.floor(Math.random() * motivationalQuotes.length); quoteDisplayEl.textContent = `"${motivationalQuotes[randomIndex]}"`; }

        // --- Milestones ---
        const milestones = [ { id: 'day7', condition: (dayIndex) => dayIndex + 1 === 7, message: "ðŸŽ‰ 1 Week Streak!" }, { id: 'day15', condition: (dayIndex) => dayIndex + 1 === 15, message: "âœ¨ 15 Days Down!" }, { id: 'halfway', condition: (dayIndex, settings) => settings.totalDays > 2 && dayIndex + 1 === Math.ceil(settings.totalDays / 2), message: "ðŸš€ Halfway There!" }, { id: 'finalweek', condition: (dayIndex, settings) => settings.totalDays > 7 && dayIndex + 1 === settings.totalDays - 6, message: "ðŸ Entering the Final Week!" } ];
        function checkMilestones(completedDayIndex) { const achieved = getAchievedMilestones(); milestones.forEach(m => { if (!achieved.includes(m.id) && m.condition(completedDayIndex, currentSettings)) { showMilestoneToast(m.message); achieved.push(m.id); saveAchievedMilestones(achieved); } }); }
        function showMilestoneToast(message) { milestoneToastEl.textContent = message; milestoneToastEl.classList.add('show'); setTimeout(() => { milestoneToastEl.classList.remove('show'); }, 4000); }
        function getAchievedMilestones() { return JSON.parse(localStorage.getItem('achievedMilestones') || '[]'); }
        function saveAchievedMilestones(achieved) { localStorage.setItem('achievedMilestones', JSON.stringify(achieved)); }

        // --- Settings Management ---
        function calculateAndDisplayProjectedBalance() {
            const initial = parseFloat(initialBalanceSettingEl.value);
            const ratePercent = parseFloat(growthRateSettingEl.value);
            const days = parseInt(totalDaysSettingEl.value, 10);
            const symbol = currencySymbolSettingEl.value || (currentSettings.currencySymbol || 'â‚¹');

            if (isNaN(initial) || initial < 0 || isNaN(ratePercent) || ratePercent < 0 || isNaN(days) || days < 1) {
                projectedEndBalanceDisplayEl.textContent = `${symbol}--.--`;
                return;
            }

            const rateDecimal = ratePercent / 100;
            let projectedBalance = initial;
            for (let i = 0; i < days; i++) {
                projectedBalance += projectedBalance * rateDecimal;
            }
            projectedEndBalanceDisplayEl.textContent = formatCurrency(projectedBalance, symbol);
        }

        function openSettingsModal() {
            if (currentSettings && currentSettings.initialBalance !== undefined) {
                initialBalanceSettingEl.value = parseFloat(currentSettings.initialBalance);
                growthRateSettingEl.value = parseFloat(currentSettings.dailyGrowthRate) * 100;
                totalDaysSettingEl.value = currentSettings.totalDays;
                currencySymbolSettingEl.value = currentSettings.currencySymbol;
                skipWeekendsSettingEl.checked = currentSettings.skipWeekends || false; // Use fetched value
                calculateAndDisplayProjectedBalance();
                openModal('settingsModal');
            } else {
                console.error("Settings button clicked, but currentSettings are not ready.");
                // Optionally show a message or disable the button more permanently
            }
        }

        async function saveSettings() {
            const newSettingsData = {
                initialBalance: parseFloat(initialBalanceSettingEl.value),
                dailyGrowthRate: parseFloat(growthRateSettingEl.value), // Send percentage
                totalDays: parseInt(totalDaysSettingEl.value, 10),
                currencySymbol: currencySymbolSettingEl.value.trim() || 'â‚¹',
                skipWeekends: skipWeekendsSettingEl.checked // Send boolean
            };

            if (isNaN(newSettingsData.initialBalance) || newSettingsData.initialBalance < 0 ||
                isNaN(newSettingsData.dailyGrowthRate) || newSettingsData.dailyGrowthRate < 0 ||
                isNaN(newSettingsData.totalDays) || newSettingsData.totalDays < 1) {
                alert("Please enter valid, non-negative numbers for Initial Balance and Growth Rate, and at least 1 Total Day.");
                return;
            }

            const saveButton = settingsModalEl.querySelector('.action-button[onclick="saveSettings()"]');
            saveButton.textContent = 'Saving...'; saveButton.disabled = true;
            const resetButton = document.getElementById('resetBtn');
            if(resetButton) resetButton.disabled = true;

            try {
                const response = await fetch(`${API_BASE_URL}/settings`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(newSettingsData)
                });
                if (!response.ok) { const errorData = await response.json().catch(() => ({ error: 'Failed to save settings' })); throw new Error(errorData.error || `HTTP error ${response.status}`); }

                // Crucial: Re-fetch all data after settings change
                await fetchInitialData();
                closeModal('settingsModal');
                alert("Settings saved successfully! The tracker has been updated.");
            } catch (error) {
                console.error("Error saving settings:", error);
                alert(`Error saving settings: ${error.message}`);
            } finally {
                 saveButton.textContent = 'Save Settings'; saveButton.disabled = false;
                 if(resetButton) resetButton.disabled = false;
            }
        }

        async function resetProgress() {
             if (!confirm("MAJOR ACTION: Are you absolutely sure you want to reset ALL progress data? This clears history and resets the current day based on saved settings. This cannot be undone.")) return;

             const resetButton = document.getElementById('resetBtn');
             resetButton.textContent = 'Resetting...'; resetButton.disabled = true;
             const saveButton = settingsModalEl.querySelector('.action-button[onclick="saveSettings()"]');
             if(saveButton) saveButton.disabled = true;

             try {
                  const response = await fetch(`${API_BASE_URL}/progress/reset`, { method: 'POST' });
                  if (!response.ok) { const errorData = await response.json().catch(() => ({ error: 'Failed to reset progress' })); throw new Error(errorData.error || `HTTP error ${response.status}`); }

                  // Crucial: Re-fetch all data after reset
                  await fetchInitialData();
                  localStorage.removeItem('achievedMilestones'); // Reset milestones too
                  closeModal('settingsModal');
                  closeModal('historyModal'); // Close history if open
                  alert("Progress has been reset.");
             } catch (error) {
                  console.error("Error resetting progress:", error);
                  alert(`Error resetting progress: ${error.message}`);
             } finally {
                 resetButton.textContent = 'Reset All Progress'; resetButton.disabled = false;
                  if(saveButton) saveButton.disabled = false;
             }
         }

        // --- Update Main UI ---
        function displayCurrentDayInfo() {
            hideMessages();

            if (!currentSettings || currentSettings.initialBalance === undefined) {
                 console.log("Waiting for settings before displaying day info.");
                 // Keep loading state or show specific message if settings failed
                 if (errorMessageEl.style.display === 'none') { // Only show loading if no error shown
                     showLoading();
                     summaryEl.innerHTML = 'Waiting for settings...';
                 }
                 return;
            }

            if (!currentDayData) {
                 console.error("Current day data is missing after fetch.");
                 showError("Failed to load current day data structure.");
                 return;
            }

            updateActualProfitLossDisplay(); // Update PL display based on current state

            if (currentDayData.all_complete) {
                currentDayInfoEl.style.display = 'none';
                completionSectionEl.style.display = 'none';
                allCompleteMessageEl.style.display = 'block';
                completeBtnEl.disabled = true;
                completeBtnEl.textContent = 'All Done!';
            } else if (currentDayData.day_number) {
                const dayNum = currentDayData.day_number;
                currentDayNumberEl.textContent = dayNum;
                const symbol = currentSettings.currencySymbol || 'â‚¹';

                // Ensure values exist before formatting
                startBalanceEl.closest('.value').innerHTML = formatCurrency(currentDayData.target_start_balance, symbol);
                targetProfitEl.closest('.value').innerHTML = formatCurrency(currentDayData.target_profit, symbol);
                endBalanceTargetEl.closest('.value').innerHTML = formatCurrency(currentDayData.target_end_balance, symbol);

                // Reset inputs for the new day
                actualEndBalanceInputEl.value = '';
                dailyNotesInputEl.value = '';
                updateActualProfitLossDisplay(); // Reset P/L display too

                completeBtnEl.textContent = `Mark Day ${dayNum} Complete`;
                completeBtnEl.disabled = false;
                completeBtnEl.setAttribute('data-day-number', dayNum);

                currentDayInfoEl.style.display = 'block';
                completionSectionEl.style.display = 'block';
                allCompleteMessageEl.style.display = 'none';
            } else {
                // This case might occur if settings exist but current day calculation failed server-side
                console.log("No current day number available, but not all complete.");
                showError("Could not determine the current day. Check server logs.");
                currentDayInfoEl.style.display = 'none';
                completionSectionEl.style.display = 'none';
                allCompleteMessageEl.style.display = 'none';
            }
        }

        function updateActualProfitLossDisplay() {
            // Ensure currentDayData and start balance are available
            if (!currentDayData || currentDayData.target_start_balance === undefined || currentDayData.all_complete) {
                actualProfitLossItemEl.style.display = 'none';
                return;
            }

            const startBalance = parseFloat(currentDayData.target_start_balance);
            const actualEndRaw = actualEndBalanceInputEl.value.trim();
            const actualEnd = parseFloat(actualEndRaw);
            const symbol = currentSettings.currencySymbol || 'â‚¹';

            if (!isNaN(startBalance) && actualEndRaw !== '' && !isNaN(actualEnd) && actualEnd >= 0) {
                const profitLoss = actualEnd - startBalance;
                actualProfitLossEl.textContent = formatCurrency(profitLoss, symbol, { signDisplay: 'always' }).replace(symbol,'');
                profitLossValueEl.className = 'value profit-loss-value'; // Reset classes
                if (profitLoss > 0) profitLossValueEl.classList.add('positive');
                else if (profitLoss < 0) profitLossValueEl.classList.add('negative');
                else profitLossValueEl.classList.add('neutral');

                if (profitLossIconEl) { profitLossIconEl.setAttribute('xlink:href', profitLoss >= 0 ? '#icon-profit' : '#icon-loss'); }
                actualProfitLossItemEl.style.display = 'flex';
            } else {
                actualProfitLossItemEl.style.display = 'none'; // Hide if input is invalid or empty
            }
        }


        // --- Button Actions ---
        async function markCurrentDayComplete() {
            const dayNumber = parseInt(completeBtnEl.getAttribute('data-day-number'), 10);
            if (isNaN(dayNumber)) { console.error("Invalid day number on complete button"); return; }

            const actualEndRaw = actualEndBalanceInputEl.value.trim();
            const dailyNotes = dailyNotesInputEl.value.trim(); // Get notes value
            const payload = { notes: dailyNotes || null }; // Send null if empty

            if (actualEndRaw !== '') {
                const actualEnd = parseFloat(actualEndRaw);
                 if (isNaN(actualEnd) || actualEnd < 0) { alert("Please enter a valid, non-negative Actual End Balance, or leave it blank."); return; }
                payload.actualEndBalance = actualEnd.toFixed(2);
            } else {
                 payload.actualEndBalance = null; // Explicitly send null if blank
            }


            completeBtnEl.disabled = true; completeBtnEl.textContent = 'Saving...';

            try {
                const response = await fetch(`${API_BASE_URL}/progress/complete/${dayNumber}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload) // Send payload with notes
                });
                if (!response.ok) { const errorData = await response.json().catch(() => ({ error: `Failed to complete day ${dayNumber}` })); throw new Error(errorData.error || `HTTP error ${response.status}`); }

                // --- SYNC FIX ---
                // Re-fetch ALL data to ensure UI is perfectly synced with backend state
                await fetchInitialData();
                // --- END SYNC FIX ---

                displayQuote(); // Display a new quote
                checkMilestones(dayNumber - 1); // Check milestones for the completed day index

            } catch (error) {
                console.error("Error completing day:", error);
                alert(`Error completing day: ${error.message}`);
                 // Re-enable button only if an error occurred and we are still on a valid day
                 if (currentDayData && currentDayData.day_number && !currentDayData.all_complete) {
                    completeBtnEl.textContent = `Mark Day ${currentDayData.day_number} Complete`;
                    completeBtnEl.disabled = false;
                 } else {
                     completeBtnEl.textContent = 'Error';
                     completeBtnEl.disabled = true;
                 }
            }
            // No finally block needed to re-enable button here,
            // fetchInitialData() handles the UI state update including the button.
        }

        // --- Update Summary & Progress ---
        function calculateCurrentStreak(history) {
            if (!history || history.length === 0) return 0;
            // Ensure history is sorted by day_number ASCENDING before calculating streak from the end
            const sortedHistory = [...history].sort((a, b) => a.day_number - b.day_number);
            let streak = 0;
            if (sortedHistory.length > 0) {
                let expectedDay = sortedHistory[sortedHistory.length - 1].day_number;
                for (let i = sortedHistory.length - 1; i >= 0; i--) {
                    if (sortedHistory[i].day_number === expectedDay) {
                        streak++;
                        expectedDay--;
                    } else {
                        // Break if there's a gap in the sequence from the end
                        break;
                    }
                }
            }
            return streak;
        }


        function updateSummary() {
            if (!currentSettings || currentSettings.totalDays === undefined) {
                 summaryEl.innerHTML = ''; progressBarFillEl.style.width = '0%'; streakInfoEl.innerHTML = ''; return;
            }

            // Use historyData which is updated by fetchInitialData
            const completedCount = historyData.length;
            const totalDays = currentSettings.totalDays || 0;
            const streak = calculateCurrentStreak(historyData); // Calculate streak based on fetched history

            if (totalDays > 0) {
                 summaryEl.innerHTML = `Progress: <span id="completedCount">${completedCount}</span> / <span id="totalDaysCount">${totalDays}</span> ${currentSettings.skipWeekends ? 'Trading' : ''} Days`;
                 const progressPercentage = totalDays > 0 ? (completedCount / totalDays) * 100 : 0;
                 progressBarFillEl.style.width = `${progressPercentage}%`;
                 if (streak > 1) { streakInfoEl.innerHTML = `ðŸ”¥ ${streak} Day Streak!`; }
                 else { streakInfoEl.innerHTML = ''; }
            } else {
                 summaryEl.innerHTML = 'Set up tracker in Settings (Total Days > 0).';
                 progressBarFillEl.style.width = '0%'; streakInfoEl.innerHTML = '';
            }
        }

        // --- Theme Toggle ---
        function toggleTheme() { const isLight = document.body.classList.toggle("light-mode"); localStorage.setItem('theme', isLight ? 'light' : 'dark'); const newThemeColor = getComputedStyle(document.body).getPropertyValue(isLight ? '--section-bg-light' : '--section-bg-dark').trim(); document.querySelector('meta[name="theme-color"]').setAttribute('content', newThemeColor); if (currentChart) { updateChartTheme(); } }
        function applySavedTheme() { const savedTheme = localStorage.getItem('theme'); const prefersDark = savedTheme === null && window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches; const useLightMode = savedTheme === 'light' || (!savedTheme && !prefersDark); if (useLightMode) { document.body.classList.add("light-mode"); } else { document.body.classList.remove("light-mode"); } const currentThemeColor = getComputedStyle(document.body).getPropertyValue(useLightMode ? '--section-bg-light' : '--section-bg-dark').trim(); document.querySelector('meta[name="theme-color"]').setAttribute('content', currentThemeColor); }

        // --- Modal Handling ---
        function openModal(modalId) { const modal = document.getElementById(modalId); if (modal) { modal.classList.add('show'); document.body.style.overflow = 'hidden'; } }
        function closeModal(modalId) { const modal = document.getElementById(modalId); if (modal) { modal.classList.remove('show'); document.body.style.overflow = 'auto'; } }
         window.onclick = function(event) { if (event.target.classList.contains('modal') && event.target.classList.contains('show')) { closeModal(event.target.id); } }

        // --- History, Stats, Chart & Filtering ---
        async function openHistoryModal() {
            // Fetch fresh history data every time the modal is opened
            // This ensures edits made elsewhere are reflected
            try {
                const response = await fetch(`${API_BASE_URL}/progress/history`);
                if (!response.ok) { const errorData = await response.json().catch(() => ({ error: 'Failed to fetch history' })); throw new Error(errorData.error || `HTTP error ${response.status}`); }
                historyData = await response.json(); // Update global history

                applyHistoryFilter(); // Apply filter (uses global historyData)

                // Populate based on filtered data
                calculateAndDisplayStats(filteredHistoryData);
                populateHistoryTable(filteredHistoryData); // Already uses filtered data

                // Render chart *after* modal is likely visible
                setTimeout(() => renderProgressChart(filteredHistoryData), 50);

                openModal('historyModal');

            } catch (error) {
                console.error("Error opening history modal:", error);
                alert(`Error loading history: ${error.message}`);
                // Clear modal content on error
                statsContainerEl.innerHTML = '<div class="stat-item"><span class="label">Error loading stats</span><span class="value">--</span></div>';
                historyTableBodyEl.innerHTML = `<tr><td colspan="8" style="text-align: center; padding: 20px;">Error loading history data.</td></tr>`;
                if (currentChart) { currentChart.destroy(); currentChart = null; }
                const chartContainer = document.getElementById('chartContainer');
                 if (chartContainer) {
                     const canvas = document.getElementById('progressChartCanvas');
                     if(canvas) canvas.style.display = 'none';
                     chartContainer.innerHTML = '<p style="text-align: center; color: var(--text-muted); padding: 20px;">Error loading chart data.</p>';
                 }
            }
        }

         function populateHistoryTable(dataToDisplay) {
            historyTableBodyEl.innerHTML = '';
            const frag = document.createDocumentFragment();
            const currency = currentSettings.currencySymbol || 'â‚¹';

            if (dataToDisplay.length === 0) {
                const filterText = historyFilterInputEl.value.trim();
                const message = filterText ? 'No history matches the current filter.' : 'No history data yet. Complete Day 1!';
                 historyTableBodyEl.innerHTML = `<tr><td colspan="8" style="text-align: center; padding: 20px;">${message}</td></tr>`;
                 return;
            }

            // Sort data for display (historyData is already sorted from API, but filtering might change order if not careful)
            const sortedData = [...dataToDisplay].sort((a, b) => a.day_number - b.day_number);

            sortedData.forEach(day => {
                const tr = document.createElement('tr');
                tr.setAttribute('data-day-number', day.day_number);
                const actualEndValue = (day.actual_end_balance !== null) ? formatCurrency(day.actual_end_balance, currency) : 'N/A';
                const actualEndRawValue = (day.actual_end_balance !== null) ? parseFloat(day.actual_end_balance).toFixed(2) : '';
                const notesValue = day.notes || ''; // Use fetched notes, default to empty string

                // Function to safely display notes in alert (escapes quotes)
                const showNotesAlert = (notesStr) => {
                    alert(`Day ${day.day_number} Notes:\n\n${notesStr.replace(/\\/g, '\\\\').replace(/'/g, "\\'").replace(/"/g, '\\"')}`);
                };

                tr.innerHTML = `
                    <td>${day.day_number}</td>
                    <td><span class="status-complete">complete</span></td>
                    <td>${formatCurrency(day.target_start_balance, currency)}</td>
                    <td>${formatCurrency(day.target_profit, currency)}</td>
                    <td>${formatCurrency(day.target_end_balance, currency)}</td>
                    <td class="actual-end-cell">
                        <span class="actual-value">${actualEndValue}</span>
                    </td>
                     <td class="notes-cell" title="${notesValue}">
                         <span class="notes-content" onclick="(${showNotesAlert.toString()})('${notesValue.replace(/'/g, "\\'")}')">${notesValue || '-'}</span>
                    </td>
                    <td class="actions-cell">
                         <button class="history-action-btn edit-balance-btn" onclick="editActualEndBalance(this)" data-current-value="${actualEndRawValue}" title="Edit Actual End Balance">
                             <svg class="icon"><use xlink:href="#icon-edit"></use></svg>
                         </button>
                         <button class="history-action-btn edit-notes-btn" onclick="editNotes(this)" data-current-value="${notesValue}" title="Edit Notes">
                             <svg class="icon"><use xlink:href="#icon-notes"></use></svg>
                         </button>
                    </td>
                `;
                frag.appendChild(tr);
            });
            historyTableBodyEl.appendChild(frag);
        }

        function applyHistoryFilter() {
            const filterText = historyFilterInputEl.value.trim().toLowerCase();
            if (!filterText) {
                filteredHistoryData = [...historyData]; // Use the globally updated historyData
            } else {
                filteredHistoryData = historyData.filter(day => {
                    const notes = (day.notes || '').toLowerCase(); // Filter based on notes
                    return notes.includes(filterText);
                });
            }
            // Re-populate table, stats, and chart based on the new filtered data
            populateHistoryTable(filteredHistoryData);
            calculateAndDisplayStats(filteredHistoryData);
            if (historyModalEl.classList.contains('show')) {
                 renderProgressChart(filteredHistoryData);
            }
        }

        function clearHistoryFilter() {
            historyFilterInputEl.value = '';
            applyHistoryFilter();
        }

        // --- EDIT FUNCTIONS (Using PATCH and new endpoint) ---
        async function editActualEndBalance(buttonElement) {
            const tableRow = buttonElement.closest('tr');
            const dayNumber = tableRow.getAttribute('data-day-number');
            const currentValue = buttonElement.getAttribute('data-current-value');
            const currency = currentSettings.currencySymbol || 'â‚¹';
            const newValueRaw = prompt(`Edit Actual End Balance for Day ${dayNumber}:\n(Leave blank to clear value)\nCurrent: ${currentValue ? formatCurrency(currentValue, currency) : 'N/A'}`, currentValue);

            if (newValueRaw === null) return; // User cancelled

            let newActualEnd = null;
            const trimmedValue = newValueRaw.trim();
            if (trimmedValue !== '') {
                 newActualEnd = parseFloat(trimmedValue);
                 if (isNaN(newActualEnd) || newActualEnd < 0) { alert("Invalid input. Please enter a non-negative number or leave blank."); return; }
                 newActualEnd = newActualEnd.toFixed(2);
            }

            // Optimistic UI update (optional, but good UX)
            const actualValueSpan = tableRow.querySelector('.actual-value');
            const optimisticDisplayValue = (newActualEnd !== null) ? formatCurrency(newActualEnd, currency) : 'N/A';
            const originalDisplayValue = actualValueSpan.textContent;
            actualValueSpan.textContent = optimisticDisplayValue;
            buttonElement.disabled = true;
            buttonElement.innerHTML = '<svg class="icon"><use xlink:href="#icon-settings"></use></svg>'; // Saving indicator

            try {
                 // Use PATCH and the new endpoint
                 const response = await fetch(`${API_BASE_URL}/progress/update/${dayNumber}`, {
                     method: 'PATCH',
                     headers: { 'Content-Type': 'application/json' },
                     body: JSON.stringify({ actualEndBalance: newActualEnd }) // Send null if cleared
                 });
                 if (!response.ok) { const errorData = await response.json().catch(() => ({ error: `Failed to update Day ${dayNumber}` })); throw new Error(errorData.error || `HTTP error ${response.status}`); }

                 const updatedData = await response.json(); // Get updated record from backend

                 // Update the main historyData array
                 const indexToUpdate = historyData.findIndex(d => d.day_number == dayNumber); // Use == for potential type coercion if needed
                 if (indexToUpdate !== -1) {
                     // Merge updated data into the local record
                     historyData[indexToUpdate] = { ...historyData[indexToUpdate], ...updatedData };
                 }

                 // Re-apply filter and update UI (table, stats, chart) based on updated historyData
                 applyHistoryFilter();

                 // No need to manually update button data-attribute if applyHistoryFilter re-renders the table

            } catch (error) {
                 console.error("Error updating actual end balance:", error);
                 alert(`Error updating Day ${dayNumber}: ${error.message}`);
                 // Rollback optimistic update on error
                 actualValueSpan.textContent = originalDisplayValue;
            } finally {
                 // Re-enable button (applyHistoryFilter might re-render, but this is safer)
                 // Find the button again in case the row was re-rendered
                 const potentiallyNewButton = historyTableBodyEl.querySelector(`tr[data-day-number="${dayNumber}"] .edit-balance-btn`);
                 if (potentiallyNewButton) {
                     potentiallyNewButton.disabled = false;
                     potentiallyNewButton.innerHTML = '<svg class="icon"><use xlink:href="#icon-edit"></use></svg>';
                 }
            }
        }

        async function editNotes(buttonElement) {
             const tableRow = buttonElement.closest('tr');
             const dayNumber = tableRow.getAttribute('data-day-number');
             const currentNotes = buttonElement.getAttribute('data-current-value');
             const newNotes = prompt(`Edit Notes for Day ${dayNumber}:\n(Leave blank to clear notes)`, currentNotes);

             if (newNotes === null) return; // User cancelled

             const trimmedNotes = newNotes.trim();

             // Optimistic UI update
             const notesContentSpan = tableRow.querySelector('.notes-content');
             const originalNotesDisplay = notesContentSpan.textContent;
             const originalTitle = tableRow.querySelector('.notes-cell').title;
             notesContentSpan.textContent = trimmedNotes || '-';
             tableRow.querySelector('.notes-cell').title = trimmedNotes;
             buttonElement.disabled = true;
             buttonElement.innerHTML = '<svg class="icon"><use xlink:href="#icon-settings"></use></svg>';

             try {
                 // Use PATCH and the new endpoint
                 const response = await fetch(`${API_BASE_URL}/progress/update/${dayNumber}`, {
                     method: 'PATCH',
                     headers: { 'Content-Type': 'application/json' },
                     body: JSON.stringify({ notes: trimmedNotes || null }) // Send null if cleared
                 });
                 if (!response.ok) { const errorData = await response.json().catch(() => ({ error: `Failed to update notes for Day ${dayNumber}` })); throw new Error(errorData.error || `HTTP error ${response.status}`); }

                 const updatedData = await response.json();

                 // Update the main historyData array
                 const indexToUpdate = historyData.findIndex(d => d.day_number == dayNumber);
                 if (indexToUpdate !== -1) {
                     historyData[indexToUpdate] = { ...historyData[indexToUpdate], ...updatedData };
                 }

                 // Re-apply filter and update UI
                 applyHistoryFilter();

             } catch (error) {
                 console.error("Error updating notes:", error);
                 alert(`Error updating notes for Day ${dayNumber}: ${error.message}`);
                 // Rollback optimistic update
                 notesContentSpan.textContent = originalNotesDisplay;
                 tableRow.querySelector('.notes-cell').title = originalTitle;
             } finally {
                 // Re-enable button
                 const potentiallyNewButton = historyTableBodyEl.querySelector(`tr[data-day-number="${dayNumber}"] .edit-notes-btn`);
                  if (potentiallyNewButton) {
                      potentiallyNewButton.disabled = false;
                      potentiallyNewButton.innerHTML = '<svg class="icon"><use xlink:href="#icon-notes"></use></svg>';
                  }
             }
         }
        // --- END EDIT FUNCTIONS ---

        function calculateAndDisplayStats(dataForStats) {
            statsContainerEl.innerHTML = ''; // Clear previous stats
            const currency = currentSettings.currencySymbol || 'â‚¹';

            if (!dataForStats || dataForStats.length === 0) {
                 statsContainerEl.innerHTML = '<div class="stat-item"><span class="label">No data for statistics</span><span class="value">--</span></div>';
                 return;
            }

            let totalCompletedDays = dataForStats.length;
            let profitableDays = 0, nonProfitableDays = 0, breakEvenDays = 0;
            let totalActualProfitLoss = 0, daysWithActualBalance = 0;
            let biggestWin = 0, biggestLoss = 0;
            let biggestWinDay = null, biggestLossDay = null;

            dataForStats.forEach(day => {
                 // Ensure values are numbers before calculation
                 const startBalanceRaw = day.target_start_balance;
                 const actualEndBalanceRaw = day.actual_end_balance;

                 if (actualEndBalanceRaw !== null && startBalanceRaw !== null) {
                     try {
                         const start = parseFloat(startBalanceRaw);
                         const end = parseFloat(actualEndBalanceRaw);
                         if (!isNaN(start) && !isNaN(end)) {
                             const dailyPL = end - start;
                             daysWithActualBalance++;
                             totalActualProfitLoss += dailyPL;
                             if (dailyPL > 0) { profitableDays++; if (dailyPL > biggestWin) { biggestWin = dailyPL; biggestWinDay = day.day_number; } }
                             else if (dailyPL < 0) { nonProfitableDays++; if (dailyPL < biggestLoss) { biggestLoss = dailyPL; biggestLossDay = day.day_number; } }
                             else { breakEvenDays++; }
                         } else {
                              console.warn(`Skipping stats calculation for day ${day.day_number} due to invalid balance values.`);
                         }
                     } catch (e) {
                          console.warn(`Error parsing balances for stats on day ${day.day_number}:`, e);
                     }
                 }
            });

             const avgDailyPL = daysWithActualBalance > 0 ? totalActualProfitLoss / daysWithActualBalance : 0;
             const totalTradingDaysWithPL = profitableDays + nonProfitableDays + breakEvenDays;
             const winRate = totalTradingDaysWithPL > 0 ? (profitableDays / totalTradingDaysWithPL) * 100 : 0;

             // Determine classes based on values
             const winRateClass = winRate >= 50 ? 'positive' : (totalTradingDaysWithPL > 0 ? 'negative' : 'neutral');
             const totalPlClass = totalActualProfitLoss > 0 ? 'positive' : (totalActualProfitLoss < 0 ? 'negative' : 'neutral');
             const avgPlClass = avgDailyPL > 0 ? 'positive' : (avgDailyPL < 0 ? 'negative' : 'neutral');


             const statsHTML = `
                 <div class="stat-item"><span class="label">Days Displayed</span><span class="value">${totalCompletedDays}</span></div>
                 <div class="stat-item"><span class="label">Profitable Days</span><span class="value positive">${profitableDays}</span></div>
                 <div class="stat-item"><span class="label">Loss Days</span><span class="value negative">${nonProfitableDays}</span></div>
                 <div class="stat-item"><span class="label">Break-Even Days</span><span class="value neutral">${breakEvenDays}</span></div>
                 <div class="stat-item"><span class="label">Win Rate</span><span class="value ${winRateClass}">${totalTradingDaysWithPL > 0 ? winRate.toFixed(1) + '%' : 'N/A'}</span></div>
                 <div class="stat-item"><span class="label">Total P/L</span><span class="value ${totalPlClass}">${daysWithActualBalance > 0 ? formatCurrency(totalActualProfitLoss, currency, { signDisplay: 'always' }) : 'N/A'}</span></div>
                 <div class="stat-item"><span class="label">Avg Daily P/L</span><span class="value ${avgPlClass}">${daysWithActualBalance > 0 ? formatCurrency(avgDailyPL, currency, { signDisplay: 'always' }) : 'N/A'}</span></div>
                 <div class="stat-item"><span class="label">Biggest Win</span><span class="value positive">${biggestWinDay ? `${formatCurrency(biggestWin, currency)} (Day ${biggestWinDay})` : 'N/A'}</span></div>
                 <div class="stat-item"><span class="label">Biggest Loss</span><span class="value negative">${biggestLossDay ? `${formatCurrency(biggestLoss, currency)} (Day ${biggestLossDay})` : 'N/A'}</span></div>
             `;
             statsContainerEl.innerHTML = statsHTML;
         }

        function renderProgressChart(dataForChart) {
            if (typeof Chart === 'undefined') {
                console.error("Chart.js not loaded.");
                // Display error in chart container
                const chartContainer = document.getElementById('chartContainer');
                if (chartContainer) {
                    const canvas = document.getElementById('progressChartCanvas');
                    if(canvas) canvas.style.display = 'none';
                    chartContainer.innerHTML = '<p style="text-align: center; color: var(--text-muted); padding: 20px;">Chart library not loaded.</p>';
                }
                return;
            }
             const canvas = document.getElementById('progressChartCanvas');
             if (!canvas) { console.error("Canvas element not found."); return; }
             canvas.style.display = 'block';
             const chartContainer = document.getElementById('chartContainer');
             const errorP = chartContainer.querySelector('p');
             if (errorP) errorP.remove();


            const labels = [];
            const targetEndData = [];
            const actualEndData = [];
            const currency = currentSettings.currencySymbol || 'â‚¹';
            // Sort data for chart display
            const sortedData = [...dataForChart].sort((a, b) => a.day_number - b.day_number);

            sortedData.forEach(day => {
                labels.push(`Day ${day.day_number}`);
                // Ensure data is parsed correctly
                targetEndData.push(day.target_end_balance !== null ? parseFloat(day.target_end_balance) : null);
                actualEndData.push(day.actual_end_balance !== null ? parseFloat(day.actual_end_balance) : null);
            });

            const ctx = canvas.getContext('2d');
            if (currentChart) { currentChart.destroy(); }

            const isLightMode = document.body.classList.contains('light-mode');
            const gridColor = isLightMode ? 'rgba(0, 0, 0, 0.1)' : 'rgba(255, 255, 255, 0.1)';
            const fontColor = isLightMode ? '#333' : '#e0e0e0';
            const accentColor = getComputedStyle(document.documentElement).getPropertyValue('--accent-color').trim();
            const successColor = getComputedStyle(document.documentElement).getPropertyValue('--success-color').trim();

            // Use Chart.js v3+ color helper if available, otherwise fallback
            let accentBgColor = isLightMode ? 'rgba(239, 71, 111, 0.1)' : 'rgba(255, 140, 66, 0.1)'; // Fallbacks
            try {
                // Chart.js v3+ uses Chart.helpers.color directly on the Chart object instance
                // For simplicity and broader compatibility, we might just use rgba strings
                // If using Chart.js v2, it was Chart.helpers.color(colorString).alpha(value).rgbString()
                // Let's stick to rgba for simplicity unless a specific Chart.js version is known
            } catch(e) { console.warn("Chart color helper issue:", e); }


            currentChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Target End Balance', data: targetEndData, borderColor: accentColor,
                            backgroundColor: accentBgColor, // Use rgba fallback
                            tension: 0.1, pointRadius: 2, pointHoverRadius: 4, fill: true,
                            segment: { // Handle nulls in target (shouldn't happen but safe)
                                 borderColor: ctx => targetEndData.includes(null) ? 'transparent' : accentColor,
                            }
                        },
                        {
                            label: 'Actual End Balance', data: actualEndData, borderColor: successColor,
                            backgroundColor: 'transparent', tension: 0.1,
                            spanGaps: false, // Don't connect lines across nulls
                            pointRadius: 2, pointHoverRadius: 4, pointBackgroundColor: successColor,
                            segment: { // Make segments with null transparent
                                borderColor: ctx => actualEndData[ctx.p0DataIndex] === null || actualEndData[ctx.p1DataIndex] === null ? 'transparent' : successColor,
                                borderDash: ctx => actualEndData[ctx.p0DataIndex] === null || actualEndData[ctx.p1DataIndex] === null ? [6, 6] : undefined, // Optional: dash line over gaps
                            }
                        }
                    ]
                },
                 options: {
                    responsive: true, maintainAspectRatio: false, interaction: { mode: 'index', intersect: false, },
                    scales: {
                        y: {
                            beginAtZero: false, // Start axis near lowest value
                            ticks: { color: fontColor, callback: value => formatCurrency(value, currency) },
                            grid: { color: gridColor, drawBorder: false }
                        },
                        x: {
                            ticks: { color: fontColor },
                            grid: { display: false, drawBorder: false }
                        }
                    },
                    plugins: {
                        legend: { labels: { color: fontColor, boxWidth: 12, padding: 15 } },
                        tooltip: {
                            backgroundColor: isLightMode ? 'rgba(0,0,0,0.7)' : 'rgba(255,255,255,0.7)',
                            titleColor: isLightMode ? '#fff' : '#000',
                            bodyColor: isLightMode ? '#fff' : '#000',
                            callbacks: {
                                label: context => {
                                    let label = context.dataset.label || '';
                                    if (label) { label += ': '; }
                                    // Check if parsed value exists and is not null before formatting
                                    if (context.parsed?.y !== null && context.parsed?.y !== undefined) {
                                        label += formatCurrency(context.parsed.y, currency);
                                    } else {
                                        label += 'N/A'; // Display N/A for null values
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        }


        function updateChartTheme() {
             if (!currentChart || typeof Chart === 'undefined') return;

             const isLightMode = document.body.classList.contains('light-mode');
             const gridColor = isLightMode ? 'rgba(0, 0, 0, 0.1)' : 'rgba(255, 255, 255, 0.1)';
             const fontColor = isLightMode ? '#333' : '#e0e0e0';
             const accentColor = getComputedStyle(document.documentElement).getPropertyValue('--accent-color').trim();
             const successColor = getComputedStyle(document.documentElement).getPropertyValue('--success-color').trim();
             const tooltipBg = isLightMode ? 'rgba(0,0,0,0.7)' : 'rgba(255,255,255,0.7)';
             const tooltipTitle = isLightMode ? '#fff' : '#000';
             const tooltipBody = isLightMode ? '#fff' : '#000';
             let accentBgColor = isLightMode ? 'rgba(239, 71, 111, 0.1)' : 'rgba(255, 140, 66, 0.1)'; // Fallbacks

             // Update options
             currentChart.options.scales.y.ticks.color = fontColor;
             currentChart.options.scales.y.grid.color = gridColor;
             currentChart.options.scales.x.ticks.color = fontColor;
             currentChart.options.plugins.legend.labels.color = fontColor;
             currentChart.options.plugins.tooltip.backgroundColor = tooltipBg;
             currentChart.options.plugins.tooltip.titleColor = tooltipTitle;
             currentChart.options.plugins.tooltip.bodyColor = tooltipBody;

             // Update dataset properties
             currentChart.data.datasets[0].borderColor = accentColor;
             currentChart.data.datasets[0].backgroundColor = accentBgColor;
             currentChart.data.datasets[1].borderColor = successColor;
             currentChart.data.datasets[1].pointBackgroundColor = successColor;
             // Re-apply segment styling if needed based on theme (though unlikely needed here)
             // currentChart.data.datasets[1].segment.borderColor = ...

             currentChart.update();
        }

        // --- Data Export ---
        async function exportData() {
             try {
                 // Use the globally updated historyData
                 if (historyData.length === 0) { alert("No completed days to export."); return; }
                 const sortedExportData = [...historyData].sort((a, b) => a.day_number - b.day_number);
                 let csvContent = "data:text/csv;charset=utf-8,";
                 // Add Notes to header
                 const headers = ["Day", "Status", "Target Start", "Target Profit", "Target End", "Actual End", "Notes"];
                 csvContent += headers.join(",") + "\r\n";

                 sortedExportData.forEach(day => {
                     const actualEndValue = (day.actual_end_balance !== null) ? parseFloat(day.actual_end_balance).toFixed(2) : '';
                     const notesValue = day.notes || ''; // Include notes
                     const row = [
                         day.day_number, 'complete',
                         parseFloat(day.target_start_balance).toFixed(2), parseFloat(day.target_profit).toFixed(2), parseFloat(day.target_end_balance).toFixed(2),
                         actualEndValue,
                         notesValue // Add notes value to row
                     ].map(value => `"${String(value).replace(/"/g, '""')}"`); // Ensure proper CSV escaping
                     csvContent += row.join(",") + "\r\n";
                 });

                 const encodedUri = encodeURI(csvContent);
                 const link = document.createElement("a");
                 link.setAttribute("href", encodedUri);
                 link.setAttribute("download", `tracker_progress_${new Date().toISOString().slice(0,10)}.csv`);
                 document.body.appendChild(link); link.click(); document.body.removeChild(link);
             } catch (error) {
                 console.error("Error exporting data:", error);
                 alert(`Error exporting data: ${error.message}`);
             }
        }

        // --- Initial Load ---
        async function fetchInitialData() {
            showLoading();
            try {
                // Use Promise.allSettled to handle potential individual fetch failures gracefully
                const results = await Promise.allSettled([
                    fetch(`${API_BASE_URL}/settings`).then(res => res.ok ? res.json() : Promise.reject(res)),
                    fetch(`${API_BASE_URL}/progress/current`).then(res => res.ok ? res.json() : Promise.reject(res)),
                    fetch(`${API_BASE_URL}/progress/history`).then(res => res.ok ? res.json() : Promise.reject(res))
                ]);

                let settingsError = null, currentDayError = null, historyError = null;

                // Process Settings
                if (results[0].status === 'fulfilled') {
                    currentSettings = results[0].value;
                } else {
                    settingsError = results[0].reason;
                    console.error("Settings fetch failed:", settingsError.status, await settingsError.text().catch(()=>""));
                }

                // Process Current Day
                if (results[1].status === 'fulfilled') {
                    currentDayData = results[1].value;
                } else {
                    currentDayError = results[1].reason;
                     console.error("Current Day fetch failed:", currentDayError.status, await currentDayError.text().catch(()=>""));
                }

                // Process History
                if (results[2].status === 'fulfilled') {
                    historyData = results[2].value;
                    // Ensure history is sorted correctly upon fetch
                    historyData.sort((a, b) => a.day_number - b.day_number);
                    filteredHistoryData = [...historyData]; // Initialize filter data
                } else {
                    historyError = results[2].reason;
                    console.error("History fetch failed:", historyError.status, await historyError.text().catch(()=>""));
                    historyData = []; // Reset history on error
                    filteredHistoryData = [];
                }

                 // Determine overall status and update UI
                 if (settingsError || currentDayError) {
                    let errorMsg = "Error initializing app: ";
                    if (settingsError) errorMsg += `Settings Error (${settingsError.status || 'Network Error'}). `;
                    if (currentDayError) errorMsg += `Current Day Error (${currentDayError.status || 'Network Error'}). `;
                    if (historyError) errorMsg += `History Error (${historyError.status || 'Network Error'}). `; // Mention history error too
                    if (errorMsg.includes('Network Error') || errorMsg.includes('Failed to fetch')) {
                         errorMsg += "Is the backend server running and accessible? Check network connection and server logs.";
                    }
                    showError(errorMsg.trim());
                 } else {
                    hideMessages();
                    // Enable buttons now that data (or lack thereof) is loaded
                    if (settingsBtnEl) settingsBtnEl.disabled = false;
                    // Enable history button even if history is empty, disable only on fetch error
                    if (historyBtnEl) historyBtnEl.disabled = (historyError !== null);

                    updateCurrencySymbols(); // Update symbols based on fetched settings
                    updateSummary(); // Update summary based on fetched history
                    displayCurrentDayInfo(); // Display current day based on fetched data
                 }

            } catch (error) {
                 // Catch unexpected errors during Promise.allSettled or processing
                 console.error("Unexpected Initialization Error:", error);
                 showError(`An unexpected error occurred during initialization: ${error.message}`);
            }
        }

        function updateCurrencySymbols() {
            if (!currentSettings) return;
            const symbol = currentSettings.currencySymbol || 'â‚¹';
            document.querySelectorAll('.currency-symbol').forEach(el => { el.textContent = symbol; });
            // Update projected balance display if settings modal elements are available
            if (initialBalanceSettingEl) {
                calculateAndDisplayProjectedBalance();
            }
        }

        // --- Service Worker Registration ---
        function registerServiceWorker() {
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                    navigator.serviceWorker.register('/service-worker.js')
                        .then(reg => console.log('SW registered scope:', reg.scope))
                        .catch(err => console.log('SW registration failed:', err));
                });
            } else { console.log('Service Worker not supported.'); }
        }

        // --- Initialize App ---
        function initializeApp() {
            applySavedTheme();
            createParticles();
            displayQuote();
            registerServiceWorker();

            // Settings listeners
            initialBalanceSettingEl.addEventListener('input', calculateAndDisplayProjectedBalance);
            growthRateSettingEl.addEventListener('input', calculateAndDisplayProjectedBalance);
            totalDaysSettingEl.addEventListener('input', calculateAndDisplayProjectedBalance);
            currencySymbolSettingEl.addEventListener('input', calculateAndDisplayProjectedBalance);

            // Current day P/L listener
            actualEndBalanceInputEl.addEventListener('input', updateActualProfitLossDisplay);

            // History filter listener
            historyFilterInputEl.addEventListener('input', applyHistoryFilter);

            fetchInitialData(); // Fetch initial data and update UI
        }

        document.addEventListener('DOMContentLoaded', initializeApp);

    </script>
</body>
</html>

